---
import { Fragment } from 'astro/jsx-runtime';
import Layout from '~/layouts/PageLayout.astro';

import Hero from '~/components/widgets/Hero.astro';
import Features from '~/components/widgets/Features.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';

import { getPageBySlug, getSectionsForPage } from '../lib/directus';

const slug = 'home';

const page = await getPageBySlug(slug);
if (!page) {
  throw new Error('Home page with slug "home" not found in Directus.');
}

const sections = await getSectionsForPage(slug);

const metadata = {
  title: page.title ?? 'Circadian',
  ignoreTitleTemplate: true,
};
---

<Layout metadata={metadata}>
  {sections.map((section) => {
    switch (section.layout_type) {
      case 'hero': {
        const title = section.title ?? page.title;
        const subtitle = section.subtitle ?? page.hero_text ?? '';
        return (
          <Hero
            actions={[]}
            image={{
              src: '~/assets/images/hero-image.png',
              alt: section.image_alt ?? 'Hero image',
            }}
          >
            <Fragment slot="title">
              {title}
            </Fragment>

            <Fragment slot="subtitle">
              {subtitle}
            </Fragment>
          </Hero>
        );
      }

      case 'text': {
        return (
          <section class="py-12 sm:py-16 lg:py-20">
            <div class="layout">
              {section.title && (
                <h2 class="text-2xl sm:text-3xl font-bold tracking-tight text-gray-900 dark:text-white mb-4">
                  {section.title}
                </h2>
              )}

              <article
                class="prose prose-lg max-w-none dark:prose-invert"
                set:html={section.body ?? page.body ?? ''}
              />
            </div>
          </section>
        );
      }

      case 'features': {
        const items = section.feature_items ?? [];
        return (
          <Features
            id={section.anchor_id ?? undefined}
            tagline={section.tagline ?? undefined}
            title={section.title ?? ''}
            subtitle={section.subtitle ?? ''}
            items={items}
          />
        );
      }

      case 'cta': {
        const title = section.title ?? '';
        const subtitle = section.subtitle ?? '';
        const primaryLabel = section.primary_action_label ?? '';
        const primaryHref = section.primary_action_href ?? '#';

        return (
          <CallToAction
            actions={
              primaryLabel
                ? [
                    {
                      variant: 'primary',
                      text: primaryLabel,
                      href: primaryHref,
                      icon: 'tabler:mail',
                    },
                  ]
                : []
            }
          >
            <Fragment slot="title">
              {title}
            </Fragment>

            <Fragment slot="subtitle">
              {subtitle}
            </Fragment>
          </CallToAction>
        );
      }

      default:
        // Unknown layout_type: skip silently
        return null;
    }
  })}
</Layout>
